{% extends "base.html" %}

{% block title %}{{ production.name }} · Kronny Showcase{% endblock %}

{% block header %}
<header class="topbar">
  <div class="topbar-left">
    <div class="brand-badge">
      <span class="logo-pill">KS</span>
      <div>
        <div class="brand-title">Kronny Showcase</div>
        <div class="brand-subtitle">artist db – control centre</div>
      </div>
    </div>
  </div>
  <div class="topbar-right">
    <a href="{{ url_for('dashboard') }}" class="btn-secondary">← Main dashboard</a>
    <div class="user-pill">
      <div class="user-initial">{{ username[:1]|upper }}</div>
      <div class="user-meta">
        <span class="user-name">{{ username }}</span>
        <span class="user-role">{{ user_role|capitalize }}</span>
      </div>
      <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
    </div>
  </div>
</header>
{% endblock %}

{% block content %}
<div class="detail-layout">
  <div class="detail-main">
    <section class="panel">
      <div class="panel-header">
        <h2>Production studio overview</h2>
      </div>
      <div class="detail-hero">
        <div class="detail-avatar">
          {% if production.logo_url %}
          <img src="{{ production.logo_url }}" alt="{{ production.name }}" />
          {% else %}
          <div class="avatar-placeholder">{{ production.name[:1]|upper }}</div>
          {% endif %}
        </div>
        <div class="detail-hero-meta">
          <h1>{{ production.name }}</h1>
          <div class="artist-meta-row">
            <span class="chip">
              Market value:
              {% if production.market_value %}
              ₹{{ "{:,}".format(production.market_value) }}
              {% else %}N/A{% endif %}
            </span>
            <span class="chip">
              Projects: {{ num_projects }}
            </span>
            <span class="chip">
              Artists: {{ num_artists }}
            </span>
            <span class="chip">
              Distributors: {{ num_distributors }}
            </span>
          </div>
        </div>
      </div>

      <div class="detail-metrics-row">
        <div class="metric-card">
          <div class="metric-label">Total views</div>
          <div class="metric-value">{{ "{:,}".format(total_views or 0) }}</div>
          <div class="metric-sub">Across all linked projects</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Catalogue size</div>
          <div class="metric-value">{{ num_projects }}</div>
          <div class="metric-sub">Projects in Artist DB</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Last project</div>
          <div class="metric-sub">
            {% if production.last_project %}
              {{ production.last_project.title or "Untitled" }}
            {% else %}
              No last project set
            {% endif %}
          </div>
          {% if production.last_project %}
          <button
            class="btn-ghost small open-project"
            data-song-link="{{ production.last_project.song_link }}"
            data-title="{{ production.last_project.title }}"
          >
            ▶ Play last release
          </button>
          {% endif %}
        </div>
      </div>
      
    </section>
    
    <section class="panel">
      <div class="panel-header">
        <h2>Revenue / valuation</h2>
      </div>
      <p class="notes-text">
        Market value is stored as a single BIGINT in the <code>productions.market_value</code>
        column. You can later extend this with per-project revenue tables, but for now it gives a
        quick snapshot of studio weight.
      </p>
    </section>
  </div>

  <div class="detail-side">
    <section class="panel">
      <div class="panel-header">
        <h2>Top projects</h2>
        <span class="badge subtle">by views</span>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
          <tr>
            <th>Project</th>
            <th>Views</th>
            <th>Play</th>
          </tr>
          </thead>
          <tbody>
          {% for pid, title, song_link, views in top_projects %}
          <tr>
            <td>{{ title or "(untitled)" }}</td>
            <td>{{ "{:,}".format(views or 0) }}</td>
            <td>
              {% if song_link %}
              <button
                class="link-btn open-project"
                data-song-link="{{ song_link }}"
                data-title="{{ title }}"
              >
                ▶
              </button>
              {% else %}
              <span class="muted">—</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          {% if not top_projects %}
          <tr><td colspan="3" class="muted">No projects with views yet.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <h2>Collaborations</h2>
        <span class="badge subtle">Artists · distributors</span>
      </div>
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
          <tr>
            <th>Project</th>
            <th>Artist</th>
            <th>Distributor</th>
          </tr>
          </thead>
          <tbody>
          {% for colab, project, artist, distributor in collabs %}
          <tr>
            <td>
              {% if project.title %}
              <button
                class="link-btn open-project"
                data-song-link="{{ project.song_link }}"
                data-title="{{ project.title }}"
              >
                {{ project.title }}
              </button>
              {% else %}
              <span class="muted">(no title)</span>
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('artist_detail', artist_id=artist.artist_id) }}"
                 class="entity-link">{{ artist.name }}</a>
            </td>
            <td>
              <a href="{{ url_for('distributor_detail', distributor_id=distributor.distributor_id) }}"
                 class="entity-link">{{ distributor.name }}</a>
            </td>
          </tr>
          {% endfor %}
          {% if not collabs %}
          <tr><td colspan="3" class="muted">No collaborations yet.</td></tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>
{% endblock %}
